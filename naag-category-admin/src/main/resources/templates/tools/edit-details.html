<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}">
<th:block th:fragment="content">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/tools}">Tools</a></li>
                <li class="breadcrumb-item active">Edit Details</li>
            </ol>
        </nav>
        <h1><i class="bi bi-pencil-square me-2"></i>Edit Tool Details</h1>
    </div>

    <!-- Error Message -->
    <div th:if="${error}" class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i><span th:text="${error}">Error message</span>
    </div>

    <!-- Tool not found -->
    <div th:if="${tool == null}" class="alert alert-warning">
        <i class="bi bi-question-circle me-2"></i>Tool not found. <a th:href="@{/tools}" class="alert-link">Return to Tools list</a>
    </div>

    <!-- Tool Basic Info -->
    <div class="card mb-4" th:if="${tool != null}">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
        </div>
        <div class="card-body">
            <form th:action="@{/tools/{id}/details(id=${tool.toolId})}" method="post" id="basicInfoForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tool ID</label>
                        <input type="text" class="form-control" th:value="${tool.toolId}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" th:value="${tool.name}" readonly>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Base URL</label>
                        <input type="text" class="form-control" th:value="${tool.baseUrl}" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">HTTP Method</label>
                        <input type="text" class="form-control" th:value="${tool.httpMethod}" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">OpenAPI Description</label>
                    <textarea class="form-control" id="description" name="description" rows="2"
                              th:text="${tool.description}"></textarea>
                </div>
                <div class="mb-3">
                    <label for="humanReadableDescription" class="form-label">Human-Readable Description</label>
                    <textarea class="form-control" id="humanReadableDescription" name="humanReadableDescription" rows="2"
                              th:text="${tool.humanReadableDescription}"
                              placeholder="A friendly description for humans/LLM"></textarea>
                </div>
                <div class="mb-3">
                    <label for="categoryId" class="form-label">Category</label>
                    <select class="form-select" id="categoryId" name="categoryId">
                        <option value="">-- No Category --</option>
                        <option th:each="category : ${categories}"
                                th:value="${category.id}"
                                th:selected="${category.id == tool.categoryId}"
                                th:text="${category.name}">Category</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-2"></i>Save Basic Info
                </button>
            </form>
        </div>
    </div>

    <!-- Input Parameters -->
    <div class="card mb-4" th:if="${tool != null and tool.parameters != null and !tool.parameters.isEmpty()}">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-arrow-right-circle me-2"></i>Input Parameters</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Required</th>
                        <th>Description</th>
                        <th>Human Description</th>
                        <th>Example</th>
                        <th>Enum Values</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <th:block th:each="prm : ${tool.parameters}">
                        <tr>
                            <td>
                                <span th:style="'margin-left: ' + ${(prm.nestingLevel ?: 0) * 20} + 'px;'">
                                    <i class="bi bi-arrow-return-right text-muted me-1" th:if="${prm.nestingLevel != null and prm.nestingLevel > 0}"></i>
                                    <code th:text="${prm.name}">name</code>
                                </span>
                            </td>
                            <td><span class="badge bg-secondary" th:text="${prm.type}">string</span></td>
                            <td>
                                <i class="bi bi-check-circle text-success" th:if="${prm.required}"></i>
                                <i class="bi bi-dash text-muted" th:unless="${prm.required}"></i>
                            </td>
                            <td class="text-muted small" th:text="${prm.description != null ? #strings.abbreviate(prm.description, 30) : '-'}">desc</td>
                            <td>
                                <span th:if="${prm.humanReadableDescription != null}" th:text="${#strings.abbreviate(prm.humanReadableDescription, 30)}"></span>
                                <span th:if="${prm.humanReadableDescription == null}" class="text-muted">(not set)</span>
                            </td>
                            <td>
                                <code th:if="${prm.example != null}" th:text="${#strings.abbreviate(prm.example, 20)}">example</code>
                                <span th:if="${prm.example == null}" class="text-muted">(not set)</span>
                            </td>
                            <td>
                                <span th:if="${prm.enumValues != null and prm.enumValues != ''}" class="badge bg-info">enum</span>
                                <span th:if="${prm.enumValues == null or prm.enumValues == ''}" class="text-muted">-</span>
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-param-btn"
                                        th:data-id="${prm.id}"
                                        th:data-name="${prm.name}"
                                        th:data-human="${prm.humanReadableDescription}"
                                        th:data-example="${prm.example}"
                                        th:data-enum="${prm.enumValues}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                        <!-- Nested parameters -->
                        <th:block th:if="${prm.nestedParameters != null and !prm.nestedParameters.isEmpty()}">
                            <tr th:each="nested : ${prm.nestedParameters}">
                                <td>
                                    <span th:style="'margin-left: ' + ${(nested.nestingLevel ?: 1) * 20} + 'px;'">
                                        <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                        <code th:text="${nested.name}">name</code>
                                    </span>
                                </td>
                                <td><span class="badge bg-secondary" th:text="${nested.type}">string</span></td>
                                <td>
                                    <i class="bi bi-check-circle text-success" th:if="${nested.required}"></i>
                                    <i class="bi bi-dash text-muted" th:unless="${nested.required}"></i>
                                </td>
                                <td class="text-muted small" th:text="${nested.description != null ? #strings.abbreviate(nested.description, 30) : '-'}">desc</td>
                                <td>
                                    <span th:if="${nested.humanReadableDescription != null}" th:text="${#strings.abbreviate(nested.humanReadableDescription, 30)}"></span>
                                    <span th:if="${nested.humanReadableDescription == null}" class="text-muted">(not set)</span>
                                </td>
                                <td>
                                    <code th:if="${nested.example != null}" th:text="${#strings.abbreviate(nested.example, 20)}">example</code>
                                    <span th:if="${nested.example == null}" class="text-muted">(not set)</span>
                                </td>
                                <td>
                                    <span th:if="${nested.enumValues != null and nested.enumValues != ''}" class="badge bg-info">enum</span>
                                    <span th:if="${nested.enumValues == null or nested.enumValues == ''}" class="text-muted">-</span>
                                </td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-param-btn"
                                            th:data-id="${nested.id}"
                                            th:data-name="${nested.name}"
                                            th:data-human="${nested.humanReadableDescription}"
                                            th:data-example="${nested.example}"
                                            th:data-enum="${nested.enumValues}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                        </th:block>
                    </th:block>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Responses -->
    <div class="card mb-4" th:if="${tool != null and tool.responses != null and !tool.responses.isEmpty()}">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-arrow-left-circle me-2"></i>Responses</h5>
        </div>
        <div class="card-body">
            <div th:each="resp : ${tool.responses}" class="mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="badge" th:classappend="${resp.statusCode != null and resp.statusCode.startsWith('2')} ? 'bg-success' : 'bg-warning'"
                              th:text="${resp.statusCode}">200</span>
                        <span th:text="${resp.description}" class="ms-2">Success</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary edit-resp-btn"
                            th:data-id="${resp.id}"
                            th:data-human="${resp.humanReadableDescription}">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
                <div th:if="${resp.humanReadableDescription != null}" class="small text-muted mb-2">
                    <strong>Human Description:</strong> <span th:text="${resp.humanReadableDescription}"></span>
                </div>

                <!-- Response Parameters -->
                <div th:if="${resp.parameters != null and !resp.parameters.isEmpty()}" class="mt-2">
                    <small class="text-muted">Response Fields:</small>
                    <table class="table table-sm table-bordered mt-1 mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Human Description</th>
                                <th>Example</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <th:block th:each="respPrm : ${resp.parameters}">
                                <tr>
                                    <td>
                                        <span th:style="'margin-left: ' + ${(respPrm.nestingLevel ?: 0) * 20} + 'px;'">
                                            <i class="bi bi-arrow-return-right text-muted me-1" th:if="${respPrm.nestingLevel != null and respPrm.nestingLevel > 0}"></i>
                                            <code th:text="${respPrm.name}">field</code>
                                        </span>
                                    </td>
                                    <td><span class="badge bg-secondary" th:text="${respPrm.type}">string</span></td>
                                    <td class="small" th:text="${respPrm.description != null ? #strings.abbreviate(respPrm.description, 30) : '-'}">desc</td>
                                    <td class="small">
                                        <span th:if="${respPrm.humanReadableDescription != null}" th:text="${#strings.abbreviate(respPrm.humanReadableDescription, 30)}"></span>
                                        <span th:if="${respPrm.humanReadableDescription == null}" class="text-muted">-</span>
                                    </td>
                                    <td class="small">
                                        <code th:if="${respPrm.example != null}" th:text="${#strings.abbreviate(respPrm.example, 20)}"></code>
                                        <span th:if="${respPrm.example == null}" class="text-muted">-</span>
                                    </td>
                                    <td class="text-end">
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-param-btn"
                                                th:data-id="${respPrm.id}"
                                                th:data-name="${respPrm.name}"
                                                th:data-human="${respPrm.humanReadableDescription}"
                                                th:data-example="${respPrm.example}"
                                                th:data-enum="${respPrm.enumValues}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- Nested response parameters -->
                                <th:block th:if="${respPrm.nestedParameters != null and !respPrm.nestedParameters.isEmpty()}">
                                    <tr th:each="nestedResp : ${respPrm.nestedParameters}">
                                        <td>
                                            <span th:style="'margin-left: ' + ${(nestedResp.nestingLevel ?: 1) * 20} + 'px;'">
                                                <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                                <code th:text="${nestedResp.name}">field</code>
                                            </span>
                                        </td>
                                        <td><span class="badge bg-secondary" th:text="${nestedResp.type}">string</span></td>
                                        <td class="small" th:text="${nestedResp.description != null ? #strings.abbreviate(nestedResp.description, 30) : '-'}">desc</td>
                                        <td class="small">
                                            <span th:if="${nestedResp.humanReadableDescription != null}" th:text="${#strings.abbreviate(nestedResp.humanReadableDescription, 30)}"></span>
                                            <span th:if="${nestedResp.humanReadableDescription == null}" class="text-muted">-</span>
                                        </td>
                                        <td class="small">
                                            <code th:if="${nestedResp.example != null}" th:text="${#strings.abbreviate(nestedResp.example, 20)}"></code>
                                            <span th:if="${nestedResp.example == null}" class="text-muted">-</span>
                                        </td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-param-btn"
                                                    th:data-id="${nestedResp.id}"
                                                    th:data-name="${nestedResp.name}"
                                                    th:data-human="${nestedResp.humanReadableDescription}"
                                                    th:data-example="${nestedResp.example}"
                                                    th:data-enum="${nestedResp.enumValues}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </th:block>
                            </th:block>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-4" th:if="${tool != null}">
        <a th:href="@{/tools/{id}/bulk-edit(id=${tool.toolId})}" class="btn btn-primary">
            <i class="bi bi-table me-2"></i>Bulk Edit Parameters
        </a>
        <a th:href="@{/tools}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Tools
        </a>
    </div>

    <!-- Edit Parameter Modal -->
    <div class="modal fade" id="editParameterModal" tabindex="-1" th:if="${tool != null}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Parameter: <span id="paramNameDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/tools/{id}/parameters(id=${tool.toolId})}" method="post" id="editParamForm">
                    <div class="modal-body">
                        <input type="hidden" id="parameterId" name="parameterId">

                        <div class="mb-3">
                            <label for="paramHumanDescription" class="form-label">Human-Readable Description</label>
                            <textarea class="form-control" id="paramHumanDescription" name="humanReadableDescription" rows="2"
                                      placeholder="A friendly description for this parameter"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="paramExample" class="form-label">Example Value</label>
                            <input type="text" class="form-control" id="paramExample" name="example"
                                   placeholder="e.g., 42, 'hello world', true">
                        </div>

                        <div class="mb-3">
                            <label for="paramEnumValues" class="form-label">Enum Values (comma-separated)</label>
                            <input type="text" class="form-control" id="paramEnumValues" name="enumValues"
                                   placeholder="e.g., red,green,blue">
                            <small class="text-muted">Leave empty if not an enum type</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Response Modal -->
    <div class="modal fade" id="editResponseModal" tabindex="-1" th:if="${tool != null}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Response Description</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/tools/{id}/responses(id=${tool.toolId})}" method="post" id="editResponseForm">
                    <div class="modal-body">
                        <input type="hidden" id="responseId" name="responseId">

                        <div class="mb-3">
                            <label for="responseHumanDescription" class="form-label">Human-Readable Description</label>
                            <textarea class="form-control" id="responseHumanDescription" name="humanReadableDescription" rows="3"
                                      placeholder="A friendly description for this response"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Edit parameter button click handler
        document.querySelectorAll('.edit-param-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.getElementById('parameterId').value = this.dataset.id;
                document.getElementById('paramNameDisplay').textContent = this.dataset.name || '';
                document.getElementById('paramHumanDescription').value = this.dataset.human || '';
                document.getElementById('paramExample').value = this.dataset.example || '';
                document.getElementById('paramEnumValues').value = this.dataset.enum || '';
                new bootstrap.Modal(document.getElementById('editParameterModal')).show();
            });
        });

        // Edit response button click handler
        document.querySelectorAll('.edit-resp-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.getElementById('responseId').value = this.dataset.id;
                document.getElementById('responseHumanDescription').value = this.dataset.human || '';
                new bootstrap.Modal(document.getElementById('editResponseModal')).show();
            });
        });
    </script>
</th:block>
</html>
