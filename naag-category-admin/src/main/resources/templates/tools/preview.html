<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}">
<th:block th:fragment="content">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/tools}">Tools</a></li>
                <li class="breadcrumb-item"><a th:href="@{/tools/register-single}">Register Single Tool</a></li>
                <li class="breadcrumb-item active">Preview</li>
            </ol>
        </nav>
        <h1><i class="bi bi-eye me-2"></i>Preview Tool</h1>
    </div>

    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form th:action="@{/tools/register-single/confirm}" method="post">
        <!-- Hidden fields for form submission -->
        <input type="hidden" name="toolId" th:value="${request.get('toolId')}">
        <input type="hidden" name="openApiEndpoint" th:value="${request.get('openApiEndpoint')}">
        <input type="hidden" name="path" th:value="${request.get('path')}">
        <input type="hidden" name="httpMethod" th:value="${request.get('httpMethod')}">
        <input type="hidden" name="categoryId" th:value="${request.get('categoryId')}">
        <!-- OpenAPI content for file-based registration -->
        <input type="hidden" name="openApiContent" th:if="${request.get('openApiContent') != null}" th:value="${request.get('openApiContent')}">

        <!-- Tool Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Tool Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th style="width: 150px;">Tool ID:</th>
                                <td><code th:text="${request.get('toolId')}"></code></td>
                            </tr>
                            <tr>
                                <th>Name:</th>
                                <td th:text="${preview.get('name') != null ? preview.get('name').asText() : ''}"></td>
                            </tr>
                            <tr>
                                <th>HTTP Method:</th>
                                <td>
                                    <th:block th:with="method=${preview.get('httpMethod') != null ? preview.get('httpMethod').asText() : ''}">
                                        <span class="badge"
                                              th:classappend="${method == 'GET' ? 'bg-success' :
                                                               method == 'POST' ? 'bg-primary' :
                                                               method == 'PUT' ? 'bg-warning' :
                                                               method == 'DELETE' ? 'bg-danger' : 'bg-secondary'}"
                                              th:text="${method}">GET</span>
                                    </th:block>
                                </td>
                            </tr>
                            <tr>
                                <th>Path:</th>
                                <td><code th:text="${preview.get('path') != null ? preview.get('path').asText() : ''}"></code></td>
                            </tr>
                            <tr th:if="${preview.get('baseUrl') != null and !preview.get('baseUrl').isNull()}">
                                <th>Base URL (from spec):</th>
                                <td><code th:text="${preview.get('baseUrl').asText()}"></code></td>
                            </tr>
                            <tr th:if="${preview.get('baseUrl') == null or preview.get('baseUrl').isNull()}">
                                <th>Base URL:</th>
                                <td><span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Not specified in OpenAPI spec - please enter below</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><strong>OpenAPI Description:</strong></label>
                            <div class="alert alert-light"
                                 th:text="${preview.get('description') != null and !preview.get('description').isNull() ? preview.get('description').asText() : '(no description)'}"></div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <label for="baseUrl" class="form-label"><strong>Base URL (editable):</strong></label>
                    <input type="text" class="form-control" id="baseUrl" name="baseUrl"
                           th:value="${request.get('baseUrl') != null and !request.get('baseUrl').isEmpty() ? request.get('baseUrl') : (preview.get('baseUrl') != null and !preview.get('baseUrl').isNull() ? preview.get('baseUrl').asText() : '')}"
                           placeholder="https://api.example.com" required>
                    <small class="text-muted">The base URL from OpenAPI spec (editable). This is where API calls will be made.</small>
                </div>

                <div class="mb-3">
                    <label for="humanReadableDescription" class="form-label">
                        <strong>Human-Readable Explanation for AI Models:</strong>
                    </label>
                    <textarea class="form-control" id="humanReadableDescription" name="humanReadableDescription"
                              rows="4" placeholder="Add a clear explanation of what this tool does, when to use it, and any important context that an AI model should know..."
                              th:text="${preview.get('description') != null and !preview.get('description').isNull() ? preview.get('description').asText() : ''}"></textarea>
                    <small class="text-muted">This helps AI models understand the purpose and usage of this tool. (Pre-populated with OpenAPI description - you can edit it)</small>
                </div>
            </div>
        </div>

        <!-- Parameters Card -->
        <div class="card mb-4" th:if="${preview.get('parameters') != null and preview.get('parameters').size() > 0}">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Input Parameters</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    <small>Add human-readable explanations and examples for each parameter to help AI models understand how to use them correctly.</small>
                </p>

                <th:block th:each="parameter : ${preview.get('parameters')}">
                    <th:block th:with="nestingLevel=${parameter.get('nestingLevel') != null ? parameter.get('nestingLevel').asInt() : 0},
                                       paramName=${parameter.get('name') != null ? parameter.get('name').asText() : ''},
                                       paramType=${parameter.get('type') != null ? parameter.get('type').asText() : 'string'},
                                       paramRequired=${parameter.get('required') != null and parameter.get('required').asBoolean()},
                                       paramIn=${parameter.get('in') != null ? parameter.get('in').asText() : ''},
                                       paramDesc=${parameter.get('description') != null and !parameter.get('description').isNull() ? parameter.get('description').asText() : ''},
                                       paramExample=${parameter.get('example') != null and !parameter.get('example').isNull() ? parameter.get('example').asText() : ''},
                                       paramEnum=${parameter.get('enumValues') != null and !parameter.get('enumValues').isNull() ? parameter.get('enumValues').asText() : ''}">
                        <div class="parameter-card mb-3 p-3 border rounded"
                             th:style="'margin-left: ' + (${nestingLevel} * 20) + 'px;'">

                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span th:if="${nestingLevel > 0}" class="text-muted me-1">|_ </span>
                                    <strong th:text="${paramName}">paramName</strong>
                                    <span class="badge bg-secondary ms-2" th:text="${paramType}">string</span>
                                    <span class="badge" th:classappend="${paramRequired ? 'bg-danger' : 'bg-info'}"
                                          th:text="${paramRequired ? 'required' : 'optional'}">required</span>
                                    <span class="badge bg-light text-dark" th:text="'in: ' + ${paramIn}">in: body</span>
                                </div>
                            </div>

                            <div class="bg-light p-2 rounded mb-3">
                                <small>
                                    <strong>OpenAPI Description:</strong>
                                    <span th:text="${paramDesc != '' ? paramDesc : '(no description)'}"></span>
                                </small>
                                <br th:if="${paramExample != ''}"/>
                                <small th:if="${paramExample != ''}">
                                    <strong>OpenAPI Example:</strong>
                                    <code th:text="${paramExample}"></code>
                                </small>
                                <br th:if="${paramEnum != ''}"/>
                                <small th:if="${paramEnum != ''}">
                                    <strong>Allowed Values:</strong>
                                    <code th:text="${paramEnum}"></code>
                                </small>
                            </div>

                            <!-- Hidden fields for parameter data -->
                            <input type="hidden" name="paramNames" th:value="${paramName}">
                            <input type="hidden" name="paramTypes" th:value="${paramType}">
                            <input type="hidden" name="paramRequired" th:value="${paramRequired}">
                            <input type="hidden" name="paramIn" th:value="${paramIn}">
                            <input type="hidden" name="paramDescriptions" th:value="${paramDesc}">
                            <input type="hidden" name="paramNestingLevels" th:value="${nestingLevel}">

                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label"><small>Human-Readable Description:</small></label>
                                    <textarea class="form-control form-control-sm" name="paramHumanDescriptions"
                                              rows="2" placeholder="Add a human-readable explanation for AI models..."
                                              th:text="${paramDesc}"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><small>Custom Example (optional):</small></label>
                                    <input class="form-control form-control-sm" name="paramExamples"
                                           type="text" th:value="${paramExample}"
                                           placeholder="Add or override example...">
                                </div>
                            </div>
                        </div>

                        <!-- Nested Parameters (Level 1) -->
                        <th:block th:if="${parameter.get('nestedParameters') != null and parameter.get('nestedParameters').size() > 0}">
                            <th:block th:each="nested1 : ${parameter.get('nestedParameters')}">
                                <th:block th:with="n1Level=${nested1.get('nestingLevel') != null ? nested1.get('nestingLevel').asInt() : 1},
                                                   n1Name=${nested1.get('name') != null ? nested1.get('name').asText() : ''},
                                                   n1Type=${nested1.get('type') != null ? nested1.get('type').asText() : 'string'},
                                                   n1Required=${nested1.get('required') != null and nested1.get('required').asBoolean()},
                                                   n1In=${nested1.get('in') != null ? nested1.get('in').asText() : ''},
                                                   n1Desc=${nested1.get('description') != null and !nested1.get('description').isNull() ? nested1.get('description').asText() : ''},
                                                   n1Example=${nested1.get('example') != null and !nested1.get('example').isNull() ? nested1.get('example').asText() : ''},
                                                   n1Enum=${nested1.get('enumValues') != null and !nested1.get('enumValues').isNull() ? nested1.get('enumValues').asText() : ''}">
                                    <div class="parameter-card mb-3 p-3 border rounded border-start border-primary border-3"
                                         th:style="'margin-left: ' + (${n1Level} * 20) + 'px;'">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                                <strong th:text="${n1Name}">nestedName</strong>
                                                <span class="badge bg-secondary ms-2" th:text="${n1Type}">string</span>
                                                <span class="badge" th:classappend="${n1Required ? 'bg-danger' : 'bg-info'}"
                                                      th:text="${n1Required ? 'required' : 'optional'}">optional</span>
                                            </div>
                                        </div>
                                        <div class="bg-light p-2 rounded mb-3">
                                            <small>
                                                <strong>Description:</strong>
                                                <span th:text="${n1Desc != '' ? n1Desc : '(no description)'}"></span>
                                            </small>
                                            <br th:if="${n1Example != ''}"/>
                                            <small th:if="${n1Example != ''}"><strong>Example:</strong> <code th:text="${n1Example}"></code></small>
                                            <br th:if="${n1Enum != ''}"/>
                                            <small th:if="${n1Enum != ''}"><strong>Allowed:</strong> <code th:text="${n1Enum}"></code></small>
                                        </div>
                                        <input type="hidden" name="paramNames" th:value="${n1Name}">
                                        <input type="hidden" name="paramTypes" th:value="${n1Type}">
                                        <input type="hidden" name="paramRequired" th:value="${n1Required}">
                                        <input type="hidden" name="paramIn" th:value="${n1In}">
                                        <input type="hidden" name="paramDescriptions" th:value="${n1Desc}">
                                        <input type="hidden" name="paramNestingLevels" th:value="${n1Level}">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <label class="form-label"><small>Human-Readable Description:</small></label>
                                                <textarea class="form-control form-control-sm" name="paramHumanDescriptions" rows="2" th:text="${n1Desc}"></textarea>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label"><small>Example:</small></label>
                                                <input class="form-control form-control-sm" name="paramExamples" type="text" th:value="${n1Example}">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Nested Parameters (Level 2) -->
                                    <th:block th:if="${nested1.get('nestedParameters') != null and nested1.get('nestedParameters').size() > 0}">
                                        <th:block th:each="nested2 : ${nested1.get('nestedParameters')}">
                                            <th:block th:with="n2Level=${nested2.get('nestingLevel') != null ? nested2.get('nestingLevel').asInt() : 2},
                                                               n2Name=${nested2.get('name') != null ? nested2.get('name').asText() : ''},
                                                               n2Type=${nested2.get('type') != null ? nested2.get('type').asText() : 'string'},
                                                               n2Required=${nested2.get('required') != null and nested2.get('required').asBoolean()},
                                                               n2In=${nested2.get('in') != null ? nested2.get('in').asText() : ''},
                                                               n2Desc=${nested2.get('description') != null and !nested2.get('description').isNull() ? nested2.get('description').asText() : ''},
                                                               n2Example=${nested2.get('example') != null and !nested2.get('example').isNull() ? nested2.get('example').asText() : ''},
                                                               n2Enum=${nested2.get('enumValues') != null and !nested2.get('enumValues').isNull() ? nested2.get('enumValues').asText() : ''}">
                                                <div class="parameter-card mb-3 p-2 border rounded border-start border-info border-2"
                                                     th:style="'margin-left: ' + (${n2Level} * 20) + 'px;'">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                                        <strong th:text="${n2Name}">nestedName</strong>
                                                        <span class="badge bg-secondary ms-2" th:text="${n2Type}">string</span>
                                                    </div>
                                                    <div class="bg-light p-2 rounded mb-2" th:if="${n2Desc != '' or n2Example != '' or n2Enum != ''}">
                                                        <small th:if="${n2Desc != ''}" th:text="${n2Desc}"></small>
                                                        <small th:if="${n2Example != ''}"> | Example: <code th:text="${n2Example}"></code></small>
                                                        <small th:if="${n2Enum != ''}"> | Enum: <code th:text="${n2Enum}"></code></small>
                                                    </div>
                                                    <input type="hidden" name="paramNames" th:value="${n2Name}">
                                                    <input type="hidden" name="paramTypes" th:value="${n2Type}">
                                                    <input type="hidden" name="paramRequired" th:value="${n2Required}">
                                                    <input type="hidden" name="paramIn" th:value="${n2In}">
                                                    <input type="hidden" name="paramDescriptions" th:value="${n2Desc}">
                                                    <input type="hidden" name="paramNestingLevels" th:value="${n2Level}">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <textarea class="form-control form-control-sm" name="paramHumanDescriptions" rows="1" th:text="${n2Desc}" placeholder="Description..."></textarea>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input class="form-control form-control-sm" name="paramExamples" type="text" th:value="${n2Example}" placeholder="Example...">
                                                        </div>
                                                    </div>
                                                </div>
                                            </th:block>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </th:block>
                        </th:block>
                    </th:block>
                </th:block>
            </div>
        </div>

        <!-- Responses Card -->
        <div class="card mb-4" th:if="${preview.get('responses') != null and preview.get('responses').size() > 0}">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-reply me-2"></i>Response Definitions</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    <small>Add human-readable explanations for each response to help AI models understand the output.</small>
                </p>

                <th:block th:each="response : ${preview.get('responses')}">
                    <th:block th:with="statusCode=${response.get('statusCode') != null ? response.get('statusCode').asText() : ''},
                                       respDesc=${response.get('description') != null and !response.get('description').isNull() ? response.get('description').asText() : ''},
                                       respType=${response.get('type') != null and !response.get('type').isNull() ? response.get('type').asText() : ''}">
                        <div class="response-card mb-4 p-3 border rounded">
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge me-2"
                                      th:classappend="${#strings.startsWith(statusCode, '2') ? 'bg-success' :
                                                       #strings.startsWith(statusCode, '4') ? 'bg-warning' :
                                                       #strings.startsWith(statusCode, '5') ? 'bg-danger' : 'bg-secondary'}"
                                      th:text="${statusCode}">200</span>
                                <span class="badge bg-light text-dark" th:if="${respType != ''}" th:text="${respType}">object</span>
                            </div>

                            <div class="bg-light p-2 rounded mb-3">
                                <small>
                                    <strong>OpenAPI Description:</strong>
                                    <span th:text="${respDesc != '' ? respDesc : '(no description)'}"></span>
                                </small>
                            </div>

                            <input type="hidden" name="responseStatusCodes" th:value="${statusCode}">
                            <input type="hidden" name="responseDescriptions" th:value="${respDesc}">
                            <input type="hidden" name="responseTypes" th:value="${respType}">

                            <div class="mb-3">
                                <label class="form-label"><small>Human-Readable Description:</small></label>
                                <textarea class="form-control form-control-sm" name="responseHumanDescriptions"
                                          rows="2" placeholder="Explain what this response means and when it occurs..."
                                          th:text="${respDesc}"></textarea>
                            </div>

                            <!-- Response Properties -->
                            <div th:if="${response.get('parameters') != null and response.get('parameters').size() > 0}" class="ms-3 mt-3 border-start ps-3">
                                <h6 class="text-muted mb-3"><i class="bi bi-list-nested me-1"></i>Response Properties</h6>

                                <th:block th:each="respParam : ${response.get('parameters')}">
                                    <th:block th:with="rpNestingLevel=${respParam.get('nestingLevel') != null ? respParam.get('nestingLevel').asInt() : 0},
                                                       rpName=${respParam.get('name') != null ? respParam.get('name').asText() : ''},
                                                       rpType=${respParam.get('type') != null ? respParam.get('type').asText() : 'string'},
                                                       rpDesc=${respParam.get('description') != null and !respParam.get('description').isNull() ? respParam.get('description').asText() : ''},
                                                       rpExample=${respParam.get('example') != null and !respParam.get('example').isNull() ? respParam.get('example').asText() : ''},
                                                       rpEnum=${respParam.get('enumValues') != null and !respParam.get('enumValues').isNull() ? respParam.get('enumValues').asText() : ''}">
                                        <div class="response-param-card mb-3 p-2 border rounded"
                                             th:style="'margin-left: ' + (${rpNestingLevel} * 20) + 'px; border-left: 3px solid #3498db !important;'">

                                            <div class="d-flex align-items-center mb-2">
                                                <span th:if="${rpNestingLevel > 0}" class="text-muted me-1">|_ </span>
                                                <strong th:text="${rpName}">propName</strong>
                                                <span class="badge bg-secondary ms-2" th:text="${rpType}">string</span>
                                            </div>

                                            <div class="bg-white p-2 rounded mb-2">
                                                <small>
                                                    <strong>OpenAPI Description:</strong>
                                                    <span th:text="${rpDesc != '' ? rpDesc : '(no description)'}"></span>
                                                </small>
                                                <br th:if="${rpExample != ''}"/>
                                                <small th:if="${rpExample != ''}">
                                                    <strong>Example:</strong>
                                                    <code th:text="${rpExample}"></code>
                                                </small>
                                                <br th:if="${rpEnum != ''}"/>
                                                <small th:if="${rpEnum != ''}">
                                                    <strong>Allowed Values:</strong>
                                                    <code th:text="${rpEnum}"></code>
                                                </small>
                                            </div>

                                            <input type="hidden" name="responseParamNames" th:value="${rpName}">
                                            <input type="hidden" name="responseParamTypes" th:value="${rpType}">
                                            <input type="hidden" name="responseParamDescriptions" th:value="${rpDesc}">
                                            <input type="hidden" name="responseParamNestingLevels" th:value="${rpNestingLevel}">
                                            <input type="hidden" name="responseParamStatusCodes" th:value="${statusCode}">

                                            <div class="row">
                                                <div class="col-md-8">
                                                    <label class="form-label"><small>Human-Readable Description:</small></label>
                                                    <textarea class="form-control form-control-sm" name="responseParamHumanDescriptions"
                                                              rows="2" placeholder="Add a human-readable explanation..."
                                                              th:text="${rpDesc}"></textarea>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label"><small>Custom Example (optional):</small></label>
                                                    <input class="form-control form-control-sm" name="responseParamExamples"
                                                           type="text" th:value="${rpExample}"
                                                           placeholder="Add example...">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Nested Response Parameters (Level 1) -->
                                        <th:block th:if="${respParam.get('nestedParameters') != null and respParam.get('nestedParameters').size() > 0}">
                                            <th:block th:each="rn1 : ${respParam.get('nestedParameters')}">
                                                <th:block th:with="rn1Level=${rn1.get('nestingLevel') != null ? rn1.get('nestingLevel').asInt() : 1},
                                                                   rn1Name=${rn1.get('name') != null ? rn1.get('name').asText() : ''},
                                                                   rn1Type=${rn1.get('type') != null ? rn1.get('type').asText() : 'string'},
                                                                   rn1Desc=${rn1.get('description') != null and !rn1.get('description').isNull() ? rn1.get('description').asText() : ''},
                                                                   rn1Example=${rn1.get('example') != null and !rn1.get('example').isNull() ? rn1.get('example').asText() : ''},
                                                                   rn1Enum=${rn1.get('enumValues') != null and !rn1.get('enumValues').isNull() ? rn1.get('enumValues').asText() : ''}">
                                                    <div class="response-param-card mb-2 p-2 border rounded border-start border-primary border-3"
                                                         th:style="'margin-left: ' + (${rn1Level} * 20) + 'px;'">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                                            <strong th:text="${rn1Name}">nestedProp</strong>
                                                            <span class="badge bg-secondary ms-2" th:text="${rn1Type}">string</span>
                                                        </div>
                                                        <div class="bg-white p-2 rounded mb-2" th:if="${rn1Desc != '' or rn1Example != '' or rn1Enum != ''}">
                                                            <small th:if="${rn1Desc != ''}" th:text="${rn1Desc}"></small>
                                                            <small th:if="${rn1Example != ''}"> | Example: <code th:text="${rn1Example}"></code></small>
                                                            <small th:if="${rn1Enum != ''}"> | Enum: <code th:text="${rn1Enum}"></code></small>
                                                        </div>
                                                        <input type="hidden" name="responseParamNames" th:value="${rn1Name}">
                                                        <input type="hidden" name="responseParamTypes" th:value="${rn1Type}">
                                                        <input type="hidden" name="responseParamDescriptions" th:value="${rn1Desc}">
                                                        <input type="hidden" name="responseParamNestingLevels" th:value="${rn1Level}">
                                                        <input type="hidden" name="responseParamStatusCodes" th:value="${statusCode}">
                                                        <div class="row">
                                                            <div class="col-md-8">
                                                                <textarea class="form-control form-control-sm" name="responseParamHumanDescriptions" rows="1" th:text="${rn1Desc}" placeholder="Description..."></textarea>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <input class="form-control form-control-sm" name="responseParamExamples" type="text" th:value="${rn1Example}" placeholder="Example...">
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Nested Response Parameters (Level 2) -->
                                                    <th:block th:if="${rn1.get('nestedParameters') != null and rn1.get('nestedParameters').size() > 0}">
                                                        <th:block th:each="rn2 : ${rn1.get('nestedParameters')}">
                                                            <th:block th:with="rn2Level=${rn2.get('nestingLevel') != null ? rn2.get('nestingLevel').asInt() : 2},
                                                                               rn2Name=${rn2.get('name') != null ? rn2.get('name').asText() : ''},
                                                                               rn2Type=${rn2.get('type') != null ? rn2.get('type').asText() : 'string'},
                                                                               rn2Desc=${rn2.get('description') != null and !rn2.get('description').isNull() ? rn2.get('description').asText() : ''},
                                                                               rn2Example=${rn2.get('example') != null and !rn2.get('example').isNull() ? rn2.get('example').asText() : ''},
                                                                               rn2Enum=${rn2.get('enumValues') != null and !rn2.get('enumValues').isNull() ? rn2.get('enumValues').asText() : ''}">
                                                                <div class="response-param-card mb-2 p-2 border rounded border-start border-info border-2"
                                                                     th:style="'margin-left: ' + (${rn2Level} * 20) + 'px;'">
                                                                    <div class="d-flex align-items-center mb-1">
                                                                        <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                                                        <strong th:text="${rn2Name}">nestedProp</strong>
                                                                        <span class="badge bg-secondary ms-2" th:text="${rn2Type}">string</span>
                                                                    </div>
                                                                    <div class="bg-white p-1 rounded mb-1" th:if="${rn2Desc != '' or rn2Example != '' or rn2Enum != ''}">
                                                                        <small th:if="${rn2Desc != ''}" th:text="${rn2Desc}"></small>
                                                                        <small th:if="${rn2Example != ''}"> | <code th:text="${rn2Example}"></code></small>
                                                                        <small th:if="${rn2Enum != ''}"> | <code th:text="${rn2Enum}"></code></small>
                                                                    </div>
                                                                    <input type="hidden" name="responseParamNames" th:value="${rn2Name}">
                                                                    <input type="hidden" name="responseParamTypes" th:value="${rn2Type}">
                                                                    <input type="hidden" name="responseParamDescriptions" th:value="${rn2Desc}">
                                                                    <input type="hidden" name="responseParamNestingLevels" th:value="${rn2Level}">
                                                                    <input type="hidden" name="responseParamStatusCodes" th:value="${statusCode}">
                                                                    <div class="row">
                                                                        <div class="col-md-8">
                                                                            <textarea class="form-control form-control-sm" name="responseParamHumanDescriptions" rows="1" th:text="${rn2Desc}" placeholder="Description..."></textarea>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <input class="form-control form-control-sm" name="responseParamExamples" type="text" th:value="${rn2Example}" placeholder="Example...">
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Nested Response Parameters (Level 3) -->
                                                                <th:block th:if="${rn2.get('nestedParameters') != null and rn2.get('nestedParameters').size() > 0}">
                                                                    <th:block th:each="rn3 : ${rn2.get('nestedParameters')}">
                                                                        <th:block th:with="rn3Level=${rn3.get('nestingLevel') != null ? rn3.get('nestingLevel').asInt() : 3},
                                                                                           rn3Name=${rn3.get('name') != null ? rn3.get('name').asText() : ''},
                                                                                           rn3Type=${rn3.get('type') != null ? rn3.get('type').asText() : 'string'},
                                                                                           rn3Desc=${rn3.get('description') != null and !rn3.get('description').isNull() ? rn3.get('description').asText() : ''},
                                                                                           rn3Example=${rn3.get('example') != null and !rn3.get('example').isNull() ? rn3.get('example').asText() : ''}">
                                                                            <div class="response-param-card mb-1 p-1 border rounded border-start border-secondary border-1"
                                                                                 th:style="'margin-left: ' + (${rn3Level} * 20) + 'px;'">
                                                                                <div class="d-flex align-items-center">
                                                                                    <i class="bi bi-arrow-return-right text-muted me-1"></i>
                                                                                    <code th:text="${rn3Name}">prop</code>
                                                                                    <span class="badge bg-light text-dark ms-1" th:text="${rn3Type}">string</span>
                                                                                    <small th:if="${rn3Desc != ''}" class="text-muted ms-2" th:text="${#strings.abbreviate(rn3Desc, 40)}"></small>
                                                                                </div>
                                                                                <input type="hidden" name="responseParamNames" th:value="${rn3Name}">
                                                                                <input type="hidden" name="responseParamTypes" th:value="${rn3Type}">
                                                                                <input type="hidden" name="responseParamDescriptions" th:value="${rn3Desc}">
                                                                                <input type="hidden" name="responseParamNestingLevels" th:value="${rn3Level}">
                                                                                <input type="hidden" name="responseParamStatusCodes" th:value="${statusCode}">
                                                                                <input type="hidden" name="responseParamHumanDescriptions" th:value="${rn3Desc}">
                                                                                <input type="hidden" name="responseParamExamples" th:value="${rn3Example}">
                                                                            </div>
                                                                        </th:block>
                                                                    </th:block>
                                                                </th:block>
                                                            </th:block>
                                                        </th:block>
                                                    </th:block>
                                                </th:block>
                                            </th:block>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex gap-2 mb-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-lg me-2"></i>Confirm Registration
            </button>
            <a th:href="@{/tools/register-single}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-arrow-left me-2"></i>Back to Form
            </a>
            <a th:href="@{/tools}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-x-lg me-2"></i>Cancel
            </a>
        </div>
    </form>
</th:block>
</html>
