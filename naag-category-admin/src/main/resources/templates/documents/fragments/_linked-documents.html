<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Linked Documents Panel -->
<th:block th:fragment="linkedDocumentsPanel(status)">
    <div class="card mb-4" th:if="${status == 'READY_FOR_REVIEW' || status == 'MOVED_TO_RAG'}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Extracted Links</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadExtractedLinks()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
        <div class="card-body">
            <div id="linksLoading" class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2 text-muted">Loading extracted links...</span>
            </div>
            <div id="linksContent" style="display: none;">
                <div id="linksSummary" class="mb-3">
                    <!-- Summary badges will be inserted here -->
                </div>
                <div id="noLinks" class="text-muted text-center py-3" style="display: none;">
                    <i class="bi bi-link-45deg fs-1 d-block mb-2 text-secondary"></i>
                    No external links found in this document.
                </div>
                <div id="linksTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Link</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="linksTableBody">
                                <!-- Links will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="ingestableSection" class="mt-3 pt-3 border-top" style="display: none;">
                        <h6><i class="bi bi-cloud-download me-1"></i>Ingestable Documents</h6>
                        <p class="text-muted small">These linked documents can be automatically fetched and ingested into the knowledge base.</p>
                        <div id="ingestableList" class="list-group list-group-flush mb-3">
                            <!-- Ingestable links will be inserted here -->
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id="ingestSelectedBtn" disabled onclick="ingestSelectedLinks()">
                            <i class="bi bi-cloud-download me-1"></i>Ingest Selected (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            <div id="linksError" class="alert alert-danger" style="display: none;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="linksErrorMessage">Failed to load links</span>
            </div>
        </div>
    </div>
</th:block>

<!-- Linked Documents Scripts -->
<th:block th:fragment="linkedDocumentsScripts(uploadId, ragServiceUrl)">
    <script th:inline="javascript">
        const linksUploadId = /*[[${uploadId}]]*/ '';
        const linksRagServiceUrl = /*[[${ragServiceUrl}]]*/ 'http://localhost:8080';

        document.addEventListener('DOMContentLoaded', function() {
            loadExtractedLinks();
        });

        async function loadExtractedLinks() {
            const loading = document.getElementById('linksLoading');
            const content = document.getElementById('linksContent');
            const error = document.getElementById('linksError');

            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';

            try {
                const response = await fetch(`${linksRagServiceUrl}/api/documents/uploads/${linksUploadId}/links`);
                if (!response.ok) throw new Error('Failed to fetch links');

                const data = await response.json();
                renderLinks(data);

                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (e) {
                console.error('Error loading links:', e);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('linksErrorMessage').textContent = e.message;
            }
        }

        function renderLinks(data) {
            const noLinks = document.getElementById('noLinks');
            const linksTable = document.getElementById('linksTable');
            const summaryDiv = document.getElementById('linksSummary');
            const tableBody = document.getElementById('linksTableBody');
            const ingestableSection = document.getElementById('ingestableSection');
            const ingestableList = document.getElementById('ingestableList');

            // Clear previous content
            summaryDiv.innerHTML = '';
            tableBody.innerHTML = '';
            ingestableList.innerHTML = '';

            if (!data.links || data.links.length === 0) {
                noLinks.style.display = 'block';
                linksTable.style.display = 'none';
                return;
            }

            noLinks.style.display = 'none';
            linksTable.style.display = 'block';

            // Render summary badges
            if (data.summary) {
                const badgeColors = {
                    'PDF_DOCUMENT': 'danger',
                    'MARKDOWN_DOCUMENT': 'info',
                    'HTML_DOCUMENT': 'warning',
                    'SPECIFICATION': 'primary',
                    'API_DOCUMENTATION': 'success',
                    'CODE_REPOSITORY': 'dark',
                    'EXTERNAL_LINK': 'secondary',
                    'INTERNAL_REFERENCE': 'light'
                };

                Object.entries(data.summary).forEach(([type, count]) => {
                    const badge = document.createElement('span');
                    badge.className = `badge bg-${badgeColors[type] || 'secondary'} me-1 mb-1`;
                    badge.textContent = `${type.replace(/_/g, ' ')}: ${count}`;
                    summaryDiv.appendChild(badge);
                });
            }

            // Render links table
            data.links.forEach(link => {
                const row = document.createElement('tr');
                const displayUrl = link.text || truncateUrl(link.url, 60);
                const typeLabel = link.type.replace(/_/g, ' ');

                row.innerHTML = `
                    <td>
                        <a href="${escapeHtml(link.url)}" target="_blank" rel="noopener noreferrer"
                           title="${escapeHtml(link.url)}">
                            ${escapeHtml(displayUrl)}
                            <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                        </a>
                    </td>
                    <td><span class="badge bg-${getTypeBadgeColor(link.type)}">${typeLabel}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${escapeHtml(link.url)}')" title="Copy URL">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Render ingestable links
            if (data.ingestableLinks && data.ingestableLinks.length > 0) {
                ingestableSection.style.display = 'block';

                data.ingestableLinks.forEach((link, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex align-items-center';
                    item.innerHTML = `
                        <input type="checkbox" class="form-check-input me-2 ingest-checkbox"
                               data-url="${escapeHtml(link.url)}" id="ingest-${index}" onchange="updateSelectedCount()">
                        <label for="ingest-${index}" class="flex-grow-1 mb-0" style="cursor: pointer;">
                            <span class="badge bg-${getTypeBadgeColor(link.type)} me-2">${link.type.replace(/_/g, ' ')}</span>
                            <span class="text-truncate d-inline-block" style="max-width: 400px;" title="${escapeHtml(link.url)}">
                                ${escapeHtml(link.text || truncateUrl(link.url, 50))}
                            </span>
                        </label>
                    `;
                    ingestableList.appendChild(item);
                });
            } else {
                ingestableSection.style.display = 'none';
            }
        }

        function getTypeBadgeColor(type) {
            const colors = {
                'PDF_DOCUMENT': 'danger',
                'MARKDOWN_DOCUMENT': 'info',
                'HTML_DOCUMENT': 'warning',
                'TEXT_DOCUMENT': 'secondary',
                'SPECIFICATION': 'primary',
                'API_DOCUMENTATION': 'success',
                'CODE_REPOSITORY': 'dark',
                'EXTERNAL_LINK': 'secondary',
                'INTERNAL_REFERENCE': 'light'
            };
            return colors[type] || 'secondary';
        }

        function truncateUrl(url, maxLength) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength - 3) + '...';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could show a toast notification here
            });
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.ingest-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('ingestSelectedBtn').disabled = count === 0;
        }

        async function ingestSelectedLinks() {
            const checkboxes = document.querySelectorAll('.ingest-checkbox:checked');
            const urls = Array.from(checkboxes).map(cb => cb.dataset.url);

            if (urls.length === 0) return;

            const btn = document.getElementById('ingestSelectedBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Ingesting...';

            // For now, just show an alert - actual implementation would call an API
            alert(`Selected ${urls.length} documents for ingestion:\n\n${urls.join('\n')}\n\nNote: Automatic web fetching and ingestion is not yet implemented. Please download and upload these documents manually.`);

            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-download me-1"></i>Ingest Selected (<span id="selectedCount">0</span>)';
            updateSelectedCount();
        }
    </script>
</th:block>

</html>
