<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Register New Tool</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .loading {
            display: none;
            margin-left: 10px;
            color: #3498db;
        }
        .duplicate-warning {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Register New Tool</h1>

        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <form th:action="@{/tools/preview}" th:object="${request}" method="post" id="registrationForm">
            <div class="form-group">
                <label for="toolId">Tool ID:</label>
                <input type="text" id="toolId" th:field="*{toolId}" required
                       placeholder="e.g., my-api-tool">
                <small>Unique identifier for this tool</small>
            </div>

            <div class="form-group">
                <label for="openApiEndpoint">OpenAPI Specification URL:</label>
                <input type="url" id="openApiEndpoint" th:field="*{openApiEndpoint}" required
                       placeholder="https://api.example.com/openapi.json">
                <small>URL to the OpenAPI/Swagger specification</small>
                <span class="loading" id="loadingPaths">Loading paths...</span>
                <button type="button" id="loadPathsBtn" class="btn btn-secondary btn-sm" style="margin-left: 10px;">Load Paths</button>
            </div>

            <div class="form-group">
                <label for="path">API Path:</label>
                <select id="path" th:field="*{path}" required disabled>
                    <option value="">Load OpenAPI spec first</option>
                </select>
                <small>Select the API endpoint path from the OpenAPI spec</small>
            </div>

            <div class="form-group">
                <label for="httpMethod">HTTP Method:</label>
                <select id="httpMethod" th:field="*{httpMethod}" required disabled>
                    <option value="">Select path first</option>
                </select>
                <small>Available methods for the selected path (auto-detected from OpenAPI)</small>
            </div>

            <div class="duplicate-warning" id="duplicateWarning">
                ⚠️ Warning: This tool (path + method) is already registered!
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submitBtn">Preview Tool</button>
                <a th:href="@{/tools}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script>
        let pathsData = [];

        document.getElementById('loadPathsBtn').addEventListener('click', loadPaths);
        document.getElementById('openApiEndpoint').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                loadPaths();
            }
        });

        document.getElementById('path').addEventListener('change', function() {
            const selectedPath = this.value;
            const pathInfo = pathsData.find(p => p.path === selectedPath);

            const methodSelect = document.getElementById('httpMethod');
            methodSelect.innerHTML = '<option value="">Select Method</option>';

            if (pathInfo && pathInfo.methods) {
                pathInfo.methods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    methodSelect.appendChild(option);
                });
                methodSelect.disabled = false;
            }

            checkDuplicate();
        });

        document.getElementById('httpMethod').addEventListener('change', checkDuplicate);

        function loadPaths() {
            const openApiUrl = document.getElementById('openApiEndpoint').value;
            if (!openApiUrl) {
                alert('Please enter OpenAPI Specification URL first');
                return;
            }

            const loading = document.getElementById('loadingPaths');
            const loadBtn = document.getElementById('loadPathsBtn');
            loading.style.display = 'inline';
            loadBtn.disabled = true;

            fetch(`/api/tools/openapi/paths?openApiUrl=${encodeURIComponent(openApiUrl)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    pathsData = data.paths;
                    const pathSelect = document.getElementById('path');
                    pathSelect.innerHTML = '<option value="">Select Path</option>';

                    data.paths.forEach(pathInfo => {
                        const option = document.createElement('option');
                        option.value = pathInfo.path;
                        option.textContent = pathInfo.path + ' (' + pathInfo.methods.join(', ') + ')';
                        pathSelect.appendChild(option);
                    });

                    pathSelect.disabled = false;
                })
                .catch(error => {
                    alert('Failed to load paths: ' + error.message);
                })
                .finally(() => {
                    loading.style.display = 'none';
                    loadBtn.disabled = false;
                });
        }

        function checkDuplicate() {
            const openApiEndpoint = document.getElementById('openApiEndpoint').value;
            const path = document.getElementById('path').value;
            const httpMethod = document.getElementById('httpMethod').value;

            if (!openApiEndpoint || !path || !httpMethod) {
                return;
            }

            fetch(`/api/tools/check-duplicate?openApiEndpoint=${encodeURIComponent(openApiEndpoint)}&path=${encodeURIComponent(path)}&httpMethod=${encodeURIComponent(httpMethod)}`)
                .then(response => response.json())
                .then(data => {
                    const warning = document.getElementById('duplicateWarning');
                    const submitBtn = document.getElementById('submitBtn');

                    if (data.exists) {
                        warning.style.display = 'block';
                        submitBtn.disabled = true;
                    } else {
                        warning.style.display = 'none';
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error checking duplicate:', error);
                });
        }
    </script>
</body>
</html>
