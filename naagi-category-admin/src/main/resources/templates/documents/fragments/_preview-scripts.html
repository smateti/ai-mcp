<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Preview Page Scripts -->
<th:block th:fragment="previewScripts(uploadId, sseEndpoint, status)">
    <script th:inline="javascript">
        const uploadId = /*[[${uploadId}]]*/ '';
        const sseEndpoint = /*[[${sseEndpoint}]]*/ '';
        const currentStatus = /*[[${status}]]*/ '';

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', function() {
            initSSE();
            initChat();
            initGenerateQA();
            initFaqSelection();
        });

        // SSE for processing updates
        function initSSE() {
            if (currentStatus && !['READY_FOR_REVIEW', 'MOVED_TO_RAG', 'FAILED', 'DELETED'].includes(currentStatus)) {
                const eventSource = new EventSource(sseEndpoint);

                eventSource.addEventListener('processing', function(event) {
                    const data = JSON.parse(event.data);
                    document.getElementById('progressBar').style.width = data.progress + '%';
                    document.getElementById('progressBar').textContent = data.progress + '%';
                    document.getElementById('progressMessage').textContent = data.message;
                });

                eventSource.addEventListener('completed', function(event) {
                    eventSource.close();
                    window.location.reload();
                });

                eventSource.addEventListener('error', function(event) {
                    eventSource.close();
                    window.location.reload();
                });

                eventSource.onerror = function(err) {
                    console.error('SSE error:', err);
                    eventSource.close();
                    setTimeout(() => window.location.reload(), 5000);
                };
            }
        }

        // Document Chat Functionality
        function initChat() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');

            if (chatInput && chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendChatMessage();
                });
            }
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const question = chatInput.value.trim();
            if (!question) return;

            // Clear placeholder if first message
            const placeholder = document.getElementById('chatPlaceholder');
            if (placeholder) {
                placeholder.remove();
            }

            // Disable input while processing
            chatInput.disabled = true;
            chatSendBtn.disabled = true;

            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = question;
            chatMessages.appendChild(userMsg);
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Add loading indicator
            const loadingId = 'loading-' + Date.now();
            const loadingMsg = document.createElement('div');
            loadingMsg.id = loadingId;
            loadingMsg.className = 'chat-message assistant';
            loadingMsg.innerHTML = '<i class="bi bi-three-dots spinning"></i> Thinking...';
            chatMessages.appendChild(loadingMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch(`/documents/uploads/${uploadId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });
                const data = await response.json();

                // Remove loading indicator
                document.getElementById(loadingId)?.remove();

                // Add assistant response
                const assistantMsg = document.createElement('div');
                if (data.success) {
                    assistantMsg.className = 'chat-message assistant';
                    assistantMsg.textContent = data.answer;
                } else {
                    assistantMsg.className = 'chat-message assistant text-danger';
                    assistantMsg.textContent = 'Error: ' + (data.error || 'Unknown error');
                }
                chatMessages.appendChild(assistantMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message assistant text-danger';
                errorMsg.textContent = 'Error: ' + error.message;
                chatMessages.appendChild(errorMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } finally {
                // Re-enable input
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // Generate More Q&A Functionality
        function initGenerateQA() {
            const generateQABtn = document.getElementById('generateQABtn');
            if (generateQABtn) {
                generateQABtn.addEventListener('click', generateMoreQA);
            }
        }

        async function generateMoreQA() {
            const generateQABtn = document.getElementById('generateQABtn');
            const fineGrainCount = document.getElementById('fineGrainCount').value;
            const summaryCount = document.getElementById('summaryCount').value;

            generateQABtn.disabled = true;
            generateQABtn.innerHTML = '<i class="bi bi-hourglass-split spinning me-1"></i>Generating...';

            try {
                const response = await fetch(`/documents/uploads/${uploadId}/generate-qa?fineGrainCount=${fineGrainCount}&summaryCount=${summaryCount}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showNotification('Generated new Q&A pairs! Reloading...', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to generate'), 'danger');
                    generateQABtn.disabled = false;
                    generateQABtn.innerHTML = '<i class="bi bi-magic me-1"></i>Generate';
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'danger');
                generateQABtn.disabled = false;
                generateQABtn.innerHTML = '<i class="bi bi-magic me-1"></i>Generate';
            }
        }

        // FAQ Selection Functionality
        function initFaqSelection() {
            const selectAllCheckbox = document.getElementById('selectAllFaq');
            const addToFaqBtn = document.getElementById('addToFaqBtn');

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    document.querySelectorAll('.faq-checkbox').forEach(cb => cb.checked = this.checked);
                    updateFaqSelectedCount();
                });
            }

            // Use event delegation for checkbox changes on the table
            const qaTable = document.querySelector('.faq-checkbox')?.closest('table');
            if (qaTable) {
                qaTable.addEventListener('change', function(e) {
                    if (e.target.classList.contains('faq-checkbox')) {
                        updateFaqSelectedCount();
                    }
                });
            }

            if (addToFaqBtn) {
                addToFaqBtn.addEventListener('click', addSelectedToFaq);
            }

            // Initialize count
            updateFaqSelectedCount();
        }

        function updateFaqSelectedCount() {
            const selectedCountSpan = document.getElementById('selectedCount');
            const addToFaqBtn = document.getElementById('addToFaqBtn');
            const allCheckboxes = document.querySelectorAll('.faq-checkbox');
            let checkedCount = 0;
            allCheckboxes.forEach(cb => {
                if (cb.checked) checkedCount++;
            });
            if (selectedCountSpan) selectedCountSpan.textContent = checkedCount;
            if (addToFaqBtn) addToFaqBtn.disabled = checkedCount === 0;
        }

        async function addSelectedToFaq() {
            const addToFaqBtn = document.getElementById('addToFaqBtn');
            const selectedQaIds = Array.from(document.querySelectorAll('.faq-checkbox:checked'))
                .map(cb => cb.dataset.qaId);

            if (selectedQaIds.length === 0) return;

            addToFaqBtn.disabled = true;
            addToFaqBtn.innerHTML = '<i class="bi bi-hourglass-split spinning me-1"></i>Adding...';

            try {
                // Add each Q&A to FAQ selection
                for (const qaId of selectedQaIds) {
                    const selectResponse = await fetch(`/documents/uploads/${uploadId}/qa/${qaId}/select-faq`, {
                        method: 'POST'
                    });
                    const selectData = await selectResponse.json();
                    if (!selectData.success) {
                        showNotification('Error selecting Q&A ' + qaId + ': ' + (selectData.error || 'Unknown error'), 'danger');
                        addToFaqBtn.disabled = false;
                        addToFaqBtn.innerHTML = '<i class="bi bi-bookmark-plus me-1"></i>Add Selected to FAQ';
                        return;
                    }
                }

                // Approve the FAQs
                const response = await fetch(`/documents/uploads/${uploadId}/approve-faqs`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showNotification(`Added ${selectedQaIds.length} Q&A pairs to FAQ!`, 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showNotification('Error approving FAQ: ' + (data.error || 'Failed to add to FAQ'), 'danger');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'danger');
            }

            addToFaqBtn.disabled = false;
            addToFaqBtn.innerHTML = '<i class="bi bi-bookmark-plus me-1"></i>Add Selected to FAQ';
        }

        // Helper functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Title Edit Functionality
        function showTitleEdit() {
            document.getElementById('titleDisplay').classList.add('d-none');
            document.getElementById('titleEdit').classList.remove('d-none');
            document.getElementById('titleInput').focus();
        }

        function cancelTitleEdit() {
            document.getElementById('titleEdit').classList.add('d-none');
            document.getElementById('titleDisplay').classList.remove('d-none');
        }

        async function saveTitle() {
            const titleInput = document.getElementById('titleInput');
            const newTitle = titleInput.value.trim();

            if (!newTitle) {
                showNotification('Title cannot be empty', 'warning');
                return;
            }

            try {
                const response = await fetch(`/documents/uploads/${uploadId}/title`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('titleText').textContent = newTitle;
                    cancelTitleEdit();
                    showNotification('Title updated successfully', 'success');
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to update title'), 'danger');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'danger');
            }
        }
    </script>
</th:block>

</html>
